.TH docker-webhook 1 "November 2025" "docker-webhook" "Makefile"
.SH NAME
docker-webhook \- Makefile reference and help-generation guide for the Noble Factor webhook project
.SH SYNOPSIS
.B make [target] [VAR=VALUE]
.SH DESCRIPTION
This manual page documents the Makefile used to build, create and operate the
Noble Factor Docker webhook image. It focuses on the Makefile's configuration
parameters (top-level variables under "PARAMETERS"), the help-generation
conventions used by the file, and the primary convenience targets you will use
when developing and operating the project locally.
.SH HELP ANNOTATION RULES
The Makefile ships a lightweight help generator. Two simple annotations control
what appears in the brief help output (the `help-short` target):
.RS
.IP "1." 3
Section headers: a line beginning with `##@` (two hashes and an at-symbol)
marks a section heading in the output.
.IP "2." 3
Target annotations: append an inline comment `##` to a target line to make it
appear in the brief help listing. The text after `##` is used as the short
description for that target. Example:
.nf
clean: ## Stop, remove network, prune unused images/containers/volumes (DANGEROUS)
.fi
.RE
.SH PARAMETERS
The Makefile exposes a compact set of configuration variables (with sensible
defaults) that influence how images and containers are built and run. Set
them on the `make` command line or export them into the environment prior
to invoking make. The most commonly used parameters are listed below.
.TP
.B CONTAINER_DOMAIN_NAME
Domain used when assembling hostnames; defaults to "localdomain".
.TP
.B CONTAINER_ENVIRONMENT
Environment name (dev, prod, etc.). When `prod` the hostname suffix is
omitted; otherwise `-$(CONTAINER_ENVIRONMENT)` is appended.
.TP
.B CONTAINER_HOSTNAME
The container hostname used for `docker` operations; defaults to
`webhook-$(LOCATION)$(hostname_suffix)`.
.TP
.B IP_ADDRESS
Optional static IP to assign to the container when creating a macvlan/bridge
network. If absent docker/compose will select an address.
.TP
.B IP_RANGE
IP subnet range used when creating macvlan networks. Required for macvlan
driver; unused for bridge networks.
.TP
.B LOCATION
Geographical/location tag used in compose files, volume layout and hostnames.
.TP
.B PLATFORM
`docker buildx` platform list; default is the host architecture, adjusted to
common naming (`amd64`/`arm64`). Affects multi-arch builds.
.TP
.B S6_OVERLAY_VERSION
Version of s6-overlay the image installs (used as a build-arg).
.TP
.B WEBHOOK_KEYVAULT_URL
The URL of the Azure Key Vault containing the JWT secret for webhook-executor
HMAC authentication. Required if webhook-executor is used as execute-command
in hooks.json.
.TP
.B WEBHOOK_EXECUTOR_EXCLUDE
Set to true to build the webhook image without the webhook-executor program.
The webhook-executor program allows webhook rules to be executed with HMAC
authentication using a JWT token stored in an Azure Key Vault. Defaults to
false (includes webhook-executor).
.TP
.B WEBHOOK_PGID
Primary group id used when adjusting ownership inside the container's volume
layout; defaults to 0.
.TP
.B WEBHOOK_PORT
Service port the webhook listens on inside the container (default 9000).
.TP
.B WEBHOOK_PUID
User id used when adjusting ownership inside the container's volume layout.
.TP
.B WEBHOOK_SECRET_NAME
The name of the secret in the Azure Key Vault that holds the JWT token for
webhook-executor. Required if webhook-executor is used as execute-command in
hooks.json.
.TP
.B WEBHOOK_VERSION
Upstream webhook application release/version used as a build-arg.
.TP
.B TAG
Image tag applied to the built image (default `1.0.0-preview.1`).
.TP
.B IMAGE, ROLE
Computed variables used to name and tag the built image; `IMAGE` defaults to
`noblefactor/webhook:$(TAG)` and `ROLE` is `webhook`.
.SH MAIN TARGETS
This section lists the key Makefile targets and what they do. Only targets
annotated with an inline `##` appear in the brief `help-short` listing.
.TP
.B help, help-short
Show a concise help listing derived from `##@` and `##` annotations in the
Makefile. `help-short` uses `awk` to print annotated targets; `help-full` will
render this man page when available.
.TP
.B clean
Stops the webhook, removes the network and prunes images/volumes. This is a
destructive operation.
.TP
.B test
Run repository test scripts. The Makefile's `test` target calls
`test/Test-DockerWebhookSanity` and `test/Test-DockerLocationGeneration`.
.TP
.B New-WebhookLocation
Generate per-location compose and certificate-request files when the
environment file is missing or stale.
.TP
.B New-WebhookImage
Build the webhook image using `docker buildx` and the Makefile's build args.
.TP
.B New-WebhookContainer
Create a container from an existing image and prepare the volume layout. This
target validates networking settings (macvlan/ip-range) before creating the
container.
.TP
.B New-WebhookCredentials (New-WebhookKeys / New-WebhookCertificates)
Helper targets that generate SSH keys and self-signed SSL certificates used by
the webhook container volumes.
.TP
.B Start-Webhook, Stop-Webhook, Restart-Webhook
Lifecycle helpers that start, stop or restart the webhook container and then
print status with `Get-WebhookStatus`.
.TP
.B Start-WebhookShell
Open an interactive shell inside the running container (convenience target).
.TP
.B Get-WebhookStatus
Print compose status as JSON using `docker compose ps --format json` piped to
`jq`.
.TP
.B Update-WebhookKeys / Update-WebhookCertificates / Update-WebhookHooks
Copy changed keys, certificates or hooks into the on-disk volume layout for
a given location; call `Restart-Webhook` to reload them in the running
container.
.SH EXAMPLES
Build a multi-arch image and load it locally (single-platform defaults to
--load):
.nf
make New-WebhookImage PLATFORM=linux/amd64 TAG=1.2.3
.fi
.TP
Create a container for your current location (uses `LOCATION` detection):
.nf
make New-WebhookContainer
.fi
.TP
Start the webhook with an explicit IP when using macvlan:
.nf
make Start-Webhook IP_ADDRESS=192.168.1.45
.fi
.SH NOTES
If you add a new target you want to appear in the brief help, append `##`
and a short description to the same line as the target declaration. Group
related targets under a single `##@` header to keep the help output tidy.
.SH SEE ALSO
Makefile(7), docker(1), docker-compose(1), jq(1), groff(1)
.SH AUTHOR
Noble Factor