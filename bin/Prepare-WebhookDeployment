#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Prepare-WebhookDeployment - Generate a Docker Compose YAML and a certificate request for deployment at a location
# shellcheck source=bin/Declare-BashScript

source "$(dirname "$0")/Declare-BashScript" "$0" \
    "help,role:,location:,country-code:,state-or-province:,city:,organization-name:,organizational-unit:,domain-name:,email-address:,env-file:" \
    "h:l:c:s:C:O:U:D:E:F:" \
    "$@"

###########
# Arguments
###########

declare -r synopsis="${script_name} [--env-file <file>] [--role <role> --location <location>\
 --country-code <cc> --state-or-province <state> --city <city> --organization-name <org>\
 --organizational-unit <ou> --domain-name <domain> --email-address <email>] [-h|--help]"

eval set -- "$script_arguments"

while :; do
    case $1 in
    -h | --help)
        usage "${synopsis}"
        shift 1
        ;;
    --env-file)
        env_file="$2"
        if [[ ! -f "$env_file" ]]; then
            error 1 "Environment file not found: $env_file"
        fi
        Set-Environment --whitelist "ROLE LOCATION COUNTRY_CODE STATE_OR_PROVINCE CITY ORGANIZATION_NAME ORGANIZATIONAL_UNIT DOMAIN_NAME EMAIL_ADDRESS" "$env_file"
        shift 2
        ;;
    --role)
        export ROLE="$2"
        shift 2
        ;;
    --location)
        export LOCATION="$2"
        shift 2
        ;;
    --country-code)
        export COUNTRY_CODE="$2"
        shift 2
        ;;
    --state-or-province)
        export STATE_OR_PROVINCE="$2"
        shift 2
        ;;
    --city)
        export CITY="$2"
        shift 2
        ;;
    --organization-name)
        export ORGANIZATION_NAME="$2"
        shift 2
        ;;
    --organizational-unit)
        export ORGANIZATIONAL_UNIT="$2"
        shift 2
        ;;
    --domain-name)
        export DOMAIN_NAME="$2"
        shift 2
        ;;
    --email-address)
        export EMAIL_ADDRESS="$2"
        shift 2
        ;;
    --)
        shift 1
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

###########
# Constants
###########

[[ -n "${ROLE:-}" ]] || error 1 "Missing value for role"
declare -r ROLE

[[ -n "${LOCATION:-}" ]] || error 1 "Missing value for location"
declare -r LOCATION

[[ -n "${COUNTRY_CODE:-}" ]] || error 1 "Missing value for country-code"
declare -r COUNTRY_CODE

[[ -n "${STATE_OR_PROVINCE:-}" ]] || error 1 "Missing value for state-or-province"
declare -r STATE_OR_PROVINCE

[[ -n "${CITY:-}" ]] || error 1 "Missing value for city"
declare -r CITY

[[ -n "${ORGANIZATION_NAME:-}" ]] || error 1 "Missing value for organization-name"
declare -r ORGANIZATION_NAME

[[ -n "${ORGANIZATIONAL_UNIT:-}" ]] || error 1 "Missing value for organizational-unit"
declare -r ORGANIZATIONAL_UNIT

[[ -n "${DOMAIN_NAME:-}" ]] || error 1 "Missing value for domain-name"
declare -r DOMAIN_NAME

[[ -n "${EMAIL_ADDRESS:-}" ]] || error 1 "Missing value for email-address"
declare -r EMAIL_ADDRESS

###########
# Main
###########

# Save exported environment variables to ${ROLE}.config/${LOCATION}/certificate-request.env

env_file="${ROLE}.config/${LOCATION}/certificate-request.env"

# Create the config directory if it doesn't exist
mkdir -p "${ROLE}.config/${LOCATION}"

cat >"$env_file" <<EOF
ROLE="${ROLE}"
LOCATION="${LOCATION}"
COUNTRY_CODE="${COUNTRY_CODE}"
STATE_OR_PROVINCE="${STATE_OR_PROVINCE}"
CITY="${CITY}"
ORGANIZATION_NAME="${ORGANIZATION_NAME}"
ORGANIZATIONAL_UNIT="${ORGANIZATIONAL_UNIT}"
DOMAIN_NAME="${DOMAIN_NAME}"
EMAIL_ADDRESS="${EMAIL_ADDRESS}"
EOF

# Create docker compose and certificate request files

declare -r ssl_certificates_dir="${ROLE}.config/${LOCATION}/ssl-certificates"
mkdir -p "$ssl_certificates_dir"

envsubst <certificate-request.conf.template >"$ssl_certificates_dir/certificate-request.conf"

note "Generated:"
note "  $ssl_certificates_dir/certificate-request.conf"

note "Saved environment variables to $env_file"

chmod -R u=rwX,g=,o= "${ROLE}.config/${LOCATION}"
