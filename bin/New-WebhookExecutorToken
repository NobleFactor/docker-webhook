#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# New-WebhookExecutorToken - Generate a JWT token with a random secret, save both to Azure Key Vault, and output the token to stdout
# shellcheck source=bin/Declare-BashScript

source "$(dirname "$0")/Declare-BashScript" "$0" "help,env-file:,algorithm:,grant-access-to:,keyvault-url:,location:,secret-name:,silent,token-name:" "h" "$@"

###########
# Functions
###########

# Portable sed -i wrapper: supports GNU sed (Linux) and BSD sed (macOS)
function sed_i() {
    local sed_expr="$1"
    shift
    local file="$1"
    shift
    if sed --version >/dev/null 2>&1; then
        sed -i "$sed_expr" "$file"
    else
        sed -i '' "$sed_expr" "$file"
    fi
}

###########
# Arguments
###########

declare -r synopsis="New-WebhookExecutorToken [--env-file ENV_FILE] [--algorithm ALGORITHM] [--keyvault-url KEYVAULT_URL] [--location LOCATION] [--secret-name SECRET_NAME] [--token-name TOKEN_NAME] --grant-access-to DISPLAY_NAME [--silent] [--help]"
eval set -- "$script_arguments"

while :; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --env-file)
        env_file="$2"
        shift 2
        ;;
    --algorithm)
        declare -r algorithm="$2"
        shift 2
        ;;
    --keyvault-url)
        declare -r keyvault_url="$2"
        shift 2
        ;;
    --location)
        declare -r location="$2"
        shift 2
        ;;
    --grant-access-to)
        declare -r grant_access_to="$2"
        shift 2
        ;;
    --secret-name)
        declare -r secret_name="$2"
        shift 2
        ;;
    --silent)
        declare -r silent=1
        shift 1
        ;;
    --)
        shift 1
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

if [[ -n ${silent:-} ]]; then
    export SILENT=1
else
    unset SILENT
fi

# --env-file

if [[ -n ${env_file:-} ]]; then
    [[ -f ${env_file} ]] || error 2 "Environment file not found: ${env_file}"
    Set-Environment --whitelist "AZURE_CLIENT_ID AZURE_TENANT_ID WEBHOOK_CONFIG WEBHOOK_KEYVAULT_URL WEBHOOK_LOCATION WEBHOOK_SECRET_NAME WEBHOOK_SP WEBHOOK_TOKEN_REFRESH_WINDOW WEBHOOK_TOKEN_TTL" "$env_file"
fi

# --algorithm

if [[ ! -v algorithm ]]; then
    declare -r algorithm=HS512
fi
[[ -n ${algorithm:-} ]] || error 2 "A non-blank value for algorithm is required."

# --grant-access-to

if [[ -n ${grant_access_to:-} ]]; then
    permit_principal_id=$(az ad sp list --display-name "$grant_access_to" --query "[0].appId" -o tsv 2>/dev/null || echo "")
    if [[ -z "$permit_principal_id" ]]; then
        error 2 "Service principal name not found: ${grant_access_to}. If you intended to grant KeyVault get permissions, ensure the service principal exists and try again."
    fi
fi

# --location

if [[ ! -v location ]]; then
    declare -r location="${WEBHOOK_LOCATION:-}"
fi
[[ -n ${location} ]] || error 2 "A non-blank value for location is required."

# --keyvault-url

if [[ ! -v keyvault_url ]]; then
    declare -r keyvault_url="${WEBHOOK_KEYVAULT_URL:-}"
fi
[[ -n ${keyvault_url:-} ]] || error 2 "A non-blank value for keyvault-url is required."

# --secret-name

if [[ ! -v secret_name ]]; then
    declare -r secret_name="${WEBHOOK_SECRET_NAME:-webhook-executor-${location}-secret}"
fi
[[ -n ${secret_name:-} ]] || error 2 "A non-blank value for secret-name is required."

###########
# Main
###########

if ! az account show >/dev/null 2>&1; then
    note "Not logged in to Azure. Running az login..."
    az login
fi

note "Generating JSON Web Token..."

declare -r vault_name=$(echo "$keyvault_url" | sed 's|https://||' | sed 's|\.vault\.azure\.net.*||')

declare -r expires=$(python3 -c "import time; print(int(time.time()) + 24*3600)")
declare -r payload="{\"iss\":\"webhook-executor\",\"sub\":\"${location}\",\"exp\":$expires}"
declare -r secret=$(openssl rand -hex 128)

declare -r jwt="$("${script_root}/New-JsonWebToken" --secret "$secret" --algorithm "$algorithm" --payload "$payload")"

if [[ -n ${SILENT:-} ]]; then
    az keyvault secret set --vault-name "$vault_name" --name "$secret_name" --value "$secret" >/dev/null 2>&1
else
    az keyvault secret set --vault-name "$vault_name" --name "$secret_name" --value "$secret"
fi

if [[ -n ${permit_principal_id:-} ]]; then

    if [[ $(az keyvault show --name "$vault_name" --query "properties.enableRbacAuthorization" -o tsv) == true ]]; then
        declare -r scope="$(az keyvault show --name "$vault_name" --query "id" -o tsv)"
        if [[ -n ${SILENT:-} ]]; then
            az role assignment create --assignee "$permit_principal_id" --role "Key Vault Secrets User" --scope "${scope}" >/dev/null 2>&1
        else
            az role assignment create --assignee "$permit_principal_id" --role "Key Vault Secrets User" --scope "${scope}"
        fi
    else
        if [[ -n ${SILENT:-} ]]; then
            az keyvault set-policy --name "$vault_name" --spn "$permit_principal_id" --secret-permissions get >/dev/null 2>&1
        else
            az keyvault set-policy --name "$vault_name" --spn "$permit_principal_id" --secret-permissions get
        fi
    fi

fi

note "Updating webhook.config/$location/hooks.env..."

mkdir -p "webhook.config/$location"
declare -r hooks_env="webhook.config/$location/hooks.env"

if [[ -f "$hooks_env" ]]; then
    if grep -q "^.*WEBHOOK_KEYVAULT_URL=" "$hooks_env"; then
        sed_i "s|^.*WEBHOOK_KEYVAULT_URL=.*|export WEBHOOK_KEYVAULT_URL=$keyvault_url|" "$hooks_env"
    else
        echo "export WEBHOOK_KEYVAULT_URL=$keyvault_url" >>"$hooks_env"
    fi
    if grep -q "^.*WEBHOOK_SECRET_NAME=" "$hooks_env"; then
        sed_i "s|^.*WEBHOOK_SECRET_NAME=.*|export WEBHOOK_SECRET_NAME=$secret_name|" "$hooks_env"
    else
        echo "export WEBHOOK_SECRET_NAME=$secret_name" >>"$hooks_env"
    fi
    if grep -q "^.*WEBHOOK_LOCATION=" "$hooks_env"; then
        sed_i "s|^.*WEBHOOK_LOCATION=.*|export WEBHOOK_LOCATION=$location|" "$hooks_env"
    else
        echo "export WEBHOOK_LOCATION=$location" >>"$hooks_env"
    fi
else
    echo "export WEBHOOK_KEYVAULT_URL=$keyvault_url" >"$hooks_env"
    echo "export WEBHOOK_SECRET_NAME=$secret_name" >>"$hooks_env"
    echo "export WEBHOOK_LOCATION=$location" >>"$hooks_env"
fi

echo ${jwt}
