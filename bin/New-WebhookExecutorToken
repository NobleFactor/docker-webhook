#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# New-WebhookExecutorToken - Generate a JWT token with a random secret and save it to Azure Key Vault
# shellcheck source=bin/Declare-BashScript

source "$(dirname "$0")/Declare-BashScript" "$0" "env-file:,algorithm:,help,keyvault-url:,location:,secret-name:,token-name:" "h" "$@"

###########
# Functions
###########

function set_env_from_file {
    local allowed_vars=(
        WEBHOOK_KEYVAULT_URL
        WEBHOOK_SECRET_NAME
        WEBHOOK_TOKEN_NAME
        WEBHOOK_LOCATION
        AZURE_CLIENT_ID
        AZURE_TENANT_ID
    )
    local env_file="$1"

    if [[ ! -f "$env_file" ]]; then
        error 1 "Environment file not found: $env_file"
    fi

    while IFS='=' read -r key value; do
        [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue # Skip comments and empty lines

        # Remove surrounding quotes from value, but do not eval or run code
        value="${value%\"}"
        value="${value#\"}"
        local recognized=false

        for var in "${allowed_vars[@]}"; do
            if [[ "$key" == "$var" ]]; then
                export "$key"="$value"
                recognized=true
                break
            fi
        done

        if [[ "$recognized" != true ]]; then
            error 1 "Unrecognized variable '$key' in $env_file"
        fi
    done <"$env_file"
}

###########
# Arguments
###########

declare -r synopsis="New-WebhookExecutorToken [--env-file ENV_FILE] [--algorithm ALGORITHM] [--keyvault-url KEYVAULT_URL] [--location LOCATION] [--secret-name SECRET_NAME] [--token-name TOKEN_NAME] --permit-spn SPN [--help]"
eval set -- "$script_arguments"

while :; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --env-file)
        env_file="$2"
        set_env_from_file "$env_file"
        shift 2
        ;;
    --algorithm)
        declare -r algorithm="$2"
        shift 2
        ;;
    --keyvault-url)
        declare -r keyvault_url="$2"
        shift 2
        ;;
    --location)
        declare -r location="$2"
        shift 2
        ;;
    --permit-spn)
        declare -r permit_spn="$2"
        shift 2
        ;;
    --secret-name)
        declare -r secret_name="$2"
        shift 2
        ;;
    --token-name)
        declare -r token_name="$2"
        shift 2
        ;;
    --)
        shift 1
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

[[ -n ${location:-} ]] || declare -r location="${WEBHOOK_LOCATION:-}"
[[ -n ${location:-} ]] || error 2 "A non-blank value for location is required."

[[ -n ${keyvault_url:-} ]] || declare -r keyvault_url="${WEBHOOK_KEYVAULT_URL:-}"
[[ -n ${keyvault_url:-} ]] || error 1 "A non-blank value for keyvault-url is required."

[[ -n ${permit_spn:-} ]] || error 1 "A non-blank value for permit-spn is required."

# Defaults

[[ -n ${secret_name:-} ]] || declare -r secret_name="${WEBHOOK_SECRET_NAME:-webhook-executor-${location}-secret}"
[[ -n ${token_name:-} ]] || declare -r token_name="${WEBHOOK_TOKEN_NAME:-webhook-executor-${location}-token}"
[[ -n ${algorithm:-} ]] || declare -r algorithm=HS512

declare -r payload="${WEBHOOK_JWT_PAYLOAD:-{\"iss\":\"webhook-executor\",\"sub\":\"${location}\",\"exp\":$(date -d '+1 hour' +%s)}"

###########
# Main
###########

if ! az account show >/dev/null 2>&1; then
    note "Not logged in to Azure. Running az login..."
    az login
fi

note "Generating JWT token and saving to Azure Key Vault"

declare -r secret=$(openssl rand -hex 128)
declare -r vault_name=$(echo "$keyvault_url" | sed 's|https://||' | sed 's|\.vault\.azure\.net.*||')
declare -r jwt=$(bin/New-JsonWebToken --secret "$secret" --algorithm "$algorithm" --payload "$payload")

echo "Generated JWT: $jwt"

az keyvault secret set --vault-name "$vault_name" --name "$secret_name" --value "$secret"
az keyvault secret set --vault-name "$vault_name" --name "$token_name" --value "$jwt"

if [[ -n ${permit_spn:-} ]]; then
    az keyvault set-policy --name "$vault_name" --spn "$permit_spn" --secret-permissions get --secret-name "$secret_name"
fi

note "Updating webhook.config/$location/hooks.env"

mkdir -p "webhook.config/$location"
declare -r hooks_env="webhook.config/$location/hooks.env"

if [[ -f "$hooks_env" ]]; then
    if grep -q "^.*WEBHOOK_KEYVAULT_URL=" "$hooks_env"; then
        sed -i "s|^.*WEBHOOK_KEYVAULT_URL=.*|export WEBHOOK_KEYVAULT_URL=$keyvault_url|" "$hooks_env"
    else
        echo "export WEBHOOK_KEYVAULT_URL=$keyvault_url" >>"$hooks_env"
    fi
    if grep -q "^.*WEBHOOK_SECRET_NAME=" "$hooks_env"; then
        sed -i "s|^.*WEBHOOK_SECRET_NAME=.*|export WEBHOOK_SECRET_NAME=$secret_name|" "$hooks_env"
    else
        echo "export WEBHOOK_SECRET_NAME=$secret_name" >>"$hooks_env"
    fi
    if grep -q "^.*WEBHOOK_LOCATION=" "$hooks_env"; then
        sed -i "s|^.*WEBHOOK_LOCATION=.*|export WEBHOOK_LOCATION=$location|" "$hooks_env"
    else
        echo "export WEBHOOK_LOCATION=$location" >>"$hooks_env"
    fi
else
    echo "export WEBHOOK_KEYVAULT_URL=$keyvault_url" >"$hooks_env"
    echo "export WEBHOOK_SECRET_NAME=$secret_name" >>"$hooks_env"
    echo "export WEBHOOK_LOCATION=$location" >>"$hooks_env"
fi
