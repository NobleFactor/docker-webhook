#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebhookReadiness - runtime readiness test for Noble Factor webhook containers
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/../bin/Declare-BashScript" "$0" "help,wait:,container:" "h" "$@"

###########
# Arguments
###########

declare -r synopsis="Test-WebhookReadiness [--container NAME|ID] [--wait N] [--help]"
eval set -- "$script_arguments"

declare -r default_image="noblefactor/webhook:1.0.0-preview.1"

while :; do
    case $1 in
    -h | --help)
        usage "$synopsis" # does not return
        shift 1
        ;;
    --container)
        declare -r container_spec="$2"
        shift 2
        ;;
    --wait)
        declare -r wait_seconds="$2"
        shift 2
        ;;
    --)
        shift 1
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

[[ -n ${wait_seconds:-} ]] || declare wait_seconds=2

declare -r image="${default_image}"

###########
# Main
###########

# check required tools
command -v docker >/dev/null 2>&1 || error 2 "docker is not installed or not in PATH"

echo "[sanity] Image: $image"

# Ensure artifacts directory exists for captured logs
mkdir -p "$(dirname "$0")/artifacts" >/dev/null 2>&1 || true
timestamp=$(date -u +%Y%m%dT%H%M%SZ)
logfile="$(dirname "$0")/artifacts/docker-logs-${timestamp}.log"

# Discover or use specified container
if [[ -n ${container_spec:-} ]]; then
    # Use the specified container name/ID
    if docker ps --filter "id=$container_spec" --format '{{.ID}}' | grep -q .; then
        container_id="$container_spec"
    elif docker ps --filter "name=$container_spec" --format '{{.ID}}' | grep -q .; then
        container_id=$(docker ps --filter "name=$container_spec" --format '{{.ID}}')
    else
        error 3 "could not find a running container with name or ID '$container_spec'"
    fi
    container_name=$(docker ps --filter "id=$container_id" --format '{{.Names}}' | head -n1)
    echo "[sanity] Using specified container $container_name (id: $container_id)"
else
    # Discover running containers started from the image
    container_id=$(docker ps --filter "ancestor=$image" --format '{{.ID}}' | head -n 1)

    if [[ -z "$container_id" ]]; then
        error 3 "could not find a running container started from image '$image'"
    fi

    container_name=$(docker ps --filter "id=$container_id" --format '{{.Names}}' | head -n1)
    echo "[sanity] Using container $container_name (id: $container_id) started from $image"
fi

echo "[sanity] Waiting up to ${wait_seconds}s (polling) for service to initialize..."
end_time=$((SECONDS + wait_seconds))
logs=''

while ((SECONDS <= end_time)); do
    logs=$(docker logs --tail 2000 "$container_name" 2>&1 || true)
    printf '%s
' "$logs" >"$logfile"
    # Quick checks for success markers
    if printf '%s' "$logs" | grep -iq "serving hooks"; then
        echo "[sanity] SUCCESS: webhook started and serving hooks detected in logs."
        echo "[sanity] Full logs saved to: $logfile"
        exit 0
    fi
    if printf '%s' "$logs" | grep -iq "version [0-9]\+\.[0-9]"; then
        echo "[sanity] INFO: webhook binary started (version found in logs), but 'serving hooks' text not matched. Check logs at: $logfile"
        exit 0
    fi
    sleep 1
done

echo
echo "[sanity] Container status:"
docker ps --filter "name=$container_name" --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}' || true

echo
echo "[sanity] Capturing final logs (last 2000 lines) to $logfile:"
logs=$(docker logs --tail 2000 "$container_name" 2>&1 || true)
printf '%s
' "$logs" >"$logfile"
printf '%s
' "$logs"

echo
echo "[sanity] Inspecting runtime files inside the container (best-effort):"
docker exec "$container_name" bash -c '
    set -o errexit -o nounset -o pipefail
    printf "== /init ==\n";
    if [[ -e /init ]]; then ls -l /init; else printf "/init not found\n"; fi;
    printf "\n== /command ==\n";
    if [[ -d /command ]]; then ls -l /command | sed -n "1,200p"; else printf "/command not found\n"; fi;
    printf "\n== /package/admin ==\n";
    if [[ -d /package/admin ]]; then ls -l /package/admin | sed -n "1,200p"; else printf "/package/admin not found\n"; fi;
' || true

echo
echo "[sanity] WARNING: could not find clear 'serving hooks' or version markers in logs. Full logs written to: $logfile"
echo "[sanity] Leaving artifacts in place for inspection (test failed)."
exit 1
