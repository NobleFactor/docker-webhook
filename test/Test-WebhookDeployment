#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebHookDeployment - Test webhook hook responses inside the container
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/bin/Declare-BashScript" "$0" "location:,target-host:,command:,help" "" "$@"

###########
# Arguments
###########

declare -r synopsis="Test-WebHookDeployment --location LOCATION --target-host HOST --command CMD [--command CMD ...] [--help]"
eval set -- "$script_arguments"

declare location=""
declare target_host=""
declare -a commands=()

while [[ $# -gt 0 ]]; do
    case $1 in
    --location)
        location="$2"
        shift 2
        ;;
    --target-host)
        target_host="$2"
        shift 2
        ;;
    --command)
        commands+=("$2")
        shift 2
        ;;
    --help)
        usage "$synopsis"
        ;;
    --)
        shift
        break
        ;;
    *)
        printf '%s\n' "Unknown option: $1" >&2
        usage "$synopsis"
        ;;
    esac
done

if [[ -z "$location" || -z "$target_host" || ${#commands[@]} -eq 0 ]]; then
    printf '%s\n' "Error: --location, --target-host, and at least one --command are required." >&2
    usage "$synopsis"
fi

###########
# Variables
###########

declare -r webhook_url="https://localhost:9000/hooks/remote-mac"
declare -r curl_timeout=10

###########
# Functions
###########

test_command() {
    local cmd="$1"
    echo "==> Testing command: $cmd"
    local response
    response=$(curl --silent --insecure --max-time "$curl_timeout" \
        "${webhook_url}?hostname=${target_host}&command=${cmd}")

    if [[ -z "$response" ]]; then
        echo "FAIL: No response from $cmd"
        return 1
    fi

    if [[ "$cmd" == "Get-MacStatus" ]]; then
        if ! echo "$response" | jq -e '.reachable and .available' >/dev/null 2>&1; then
            echo "FAIL: Invalid JSON response for $cmd: $response"
            return 1
        fi
    else
        if ! echo "$response" | jq -e '.exit_code and .reason and (.error == null or type == "string")' >/dev/null 2>&1; then
            echo "FAIL: Invalid JSON response for $cmd: $response"
            return 1
        fi
    fi

    echo "PASS: $cmd returned valid JSON: $response"
    return 0
}

###########
# Main
###########

echo "Starting webhook deployment tests for location: $location, host: $target_host"

# Wait a bit for webhook to be ready
sleep 2

failed_tests=0

for cmd in "${commands[@]}"; do
    if ! test_command "$cmd"; then
        ((failed_tests++))
    fi
done

echo "Tests completed. Failed: $failed_tests"

if [[ $failed_tests -gt 0 ]]; then
    echo "Some tests failed."
    exit 1
else
    echo "All tests passed."
    exit 0
fi
