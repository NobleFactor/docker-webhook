#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebhookExecutorStandalone - Test webhook-executor binary directly
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/../bin/Declare-BashScript" "$0" "command:,destination:,location:,token-name:,help" "h" "$@"

###########
# Functions
###########

function test_command {
    local cmd="$1"

    echo "==> Testing command: $cmd"

    local response=$(cd src &&
        WEBHOOK_KEYVAULT_URL="${WEBHOOK_KEYVAULT_URL}" \
            WEBHOOK_SECRET_NAME="${WEBHOOK_SECRET_NAME}" \
            WEBHOOK_LOCATION="${WEBHOOK_LOCATION}" \
            WEBHOOK_CONFIG="${webhook_config}" \
            go run ./cmd/webhook-executor --destination "$destination" --command "$cmd" --authorization "$jwt" 2>/dev/null)

    if [[ -z "$response" ]]; then
        error 0 "FAIL: No response from $cmd"
        return 1
    fi

    if ! echo "$response" | jq -e '.exit_code and .reason and (.error == null or type == "string") and has("stdout") and has("stderr")' >/dev/null 2>&1; then
        error 0 "FAIL: Invalid JSON response for $cmd: $response"
        return 1
    fi

    success "PASS: $cmd returned valid JSON: $response"
    return 0
}

###########
# Arguments
###########

declare -r synopsis="${script_name} --location LOCATION --token-name TOKEN_NAME --destination DESTINATION --command CMD [--command CMD ...] [--help]"
eval set -- "$script_arguments"
declare -a commands=()

while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --command)
        commands+=("$2")
        shift 2
        ;;
    --destination)
        declare -r destination="$2"
        shift 2
        ;;
    --location)
        declare -r location="$2"
        shift 2
        ;;
    --token-name)
        declare -r token_name="$2"
        shift 2
        ;;
    --)
        shift
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

((${#commands[@]} > 0)) || error 1 "At least one command to test is required."
[[ -n ${destination:-} ]] || error 1 "A non-blank value for destination is required."
[[ -n ${location:-} ]] || error 1 "A non-blank value for location is required."
[[ -n ${token_name:-} ]] || error 1 "A non-blank value for token-name is required."

# Source the hooks.env file
declare -r hooks_env="webhook.config/$location/hooks.env"
if [[ ! -f "$hooks_env" ]]; then
    error 1 "Hooks environment file not found: $hooks_env"
fi
source "$hooks_env"

# Fetch the JWT from Azure Key Vault
declare -r vault_name=$(echo "$WEBHOOK_KEYVAULT_URL" | sed 's|https://||' | sed 's|\.vault\.azure\.net.*||')
declare -r jwt=$(az keyvault secret show --vault-name "$vault_name" --name "$token_name" --query value -o tsv)
if [[ -z "$jwt" ]]; then
    error 1 "Failed to fetch JWT from Azure Key Vault"
fi

# Set WEBHOOK_CONFIG
declare -r webhook_config="webhook.config/$location"

###########
# Main
###########

declare -r start_time=$(date +%s)

note "Starting standalone webhook-executor tests for destination: $destination"
passed_tests=0
failed_tests=0

for cmd in "${commands[@]}"; do
    if test_command "$cmd"; then
        ((passed_tests++))
    else
        ((failed_tests++))
    fi
done

declare -r end_time=$(date +%s)
declare -r elapsed=$((end_time - start_time))

note "Test Run Complete:
Status: [$passed_tests Passed, $failed_tests Failed]
Duration: ${elapsed}s"
