#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebhookExecutorIntegration - Test webhook hook responses inside the container via webhook service
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/../bin/Declare-BashScript" "$0" "help,command:,container:,destination:,location:" "h" "$@"

###########
# Variables
###########

declare -r curl_timeout=10

###########
# Functions
###########

function test_command {

    local cmd="$1"
    local correlationId="$(uuidgen)"

    note "==> Testing command: $cmd"

    local response=$(curl --silent --insecure --max-time "$curl_timeout" \
        -H "Authorization: Bearer ${auth_token}" \
        -G "${webhook_url}" \
        --data-urlencode "destination=${destination}" \
        --data-urlencode "command=${cmd}" \
        --data-urlencode "correlationId=${correlationId}")

    if [[ -z "$response" ]]; then
        error 0 "FAIL: No response from ${webhook_url} for $cmd."
        return 1
    fi

    if ! echo "$response" | jq -e '.exit_code and .reason and (.error == null or type == "string") and has("stdout") and has("stderr")' >/dev/null 2>&1; then
        error 0 "FAIL: Invalid response from ${webhook_url} for $cmd: $response"
        return 1
    fi

    success "PASS: $cmd returned valid JSON: $response"
    return 0
}

function wait_for_container_and_user {

    local container="$1"
    local user="$2"
    local timeout="${3:-60}"
    local end="$(($(date +%s) + timeout))"

    while (($(date +%s) < end)); do
        local cid
        cid=$(sudo docker ps --filter "name=$container" --filter "status=running" -q 2>/dev/null) || cid=""
        if [[ -n "$cid" ]] && sudo docker exec "$container" id "$user" >/dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done

    error 1 "timed out waiting for ${container}/${user}"
}

###########
# Arguments
###########

declare -r synopsis="${script_name} --help | --location LOCATION --container CONTAINER --destination DESTINATION --command CMD [--command CMD ...]"
eval set -- "$script_arguments"

while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --command)
        commands="$2"
        shift 2
        ;;
    --container)
        container="$2"
        shift 2
        ;;
    --destination)
        destination="$2"
        shift 2
        ;;
    --location)
        location="$2"
        shift 2
        ;;
    --)
        shift
        break
        ;;
    *)
        error 2 "Unrecognized option: $1"
        ;;
    esac
done

# --command

[[ -n ${commands:-} ]] || error 2 "A semicolon-separated list of test commands is required."
declare -r commands

# --container

[[ -n ${container:-} ]] || error 2 "A container is required."

if [[ -z $(sudo docker container ls -a -f name=${container} -q) ]]; then
    error 2 "Container does not exist: $container"
fi

declare -r container

# --destination

if [[ -z ${destination:-} ]]; then
    error 2 "An SSH destination is required."
fi

if ! echo "$destination" | grep -E '^(ssh://)?([A-Za-z0-9_][-A-Za-z0-9_.]*@)?(\[[0-9A-Fa-f:%.]+\]|[0-9]{1,3}(\.[0-9]{1,3}){3}|[A-Za-z0-9][-A-Za-z0-9_.]*)(:[0-9]{1,5})?$' >/dev/null; then
    error 2 "Invalid SSH destination format: $destination (must be [user@]host or ssh://[user@]host[:port])"
fi

declare -r destination

# --location

[[ -n ${location:-} ]] || error 2 "A value for location is required."
declare -r location

###########
# Main
###########

# Set webhook config directory location

cd "${script_root}/.." && declare -r webhook_config=$(realpath "volumes/$location")
[[ -d ${webhook_config:-} ]] || error 1 "Webhook configuration directory for ${location} not found: ${webhook_config}"

# Source hooks environment

[[ -f ${webhook_config}/hooks.env ]] || error 1 "Webhook executor enviroment for ${location} not found: ${webhook_config}/hooks.env"
Set-Environment --whitelist "AZURE_CLIENT_ID AZURE_TENANT_ID WEBHOOK_CONFIG WEBHOOK_KEYVAULT_URL WEBHOOK_LOCATION WEBHOOK_SECRET_NAME WEBHOOK_SP WEBHOOK_TOKEN_REFRESH_WINDOW WEBHOOK_TOKEN_TTL" "${webhook_config}/hooks.env"

# Ensure container is running

if [[ -z $(sudo docker ps -q -f name=${container}) ]]; then
    sudo docker container start ${container}
    wait_for_container_and_user ${container} webhook 60
fi

# Extract webhook URL using container's IP and internal port

declare -r container_ip=$(sudo docker inspect ${container} --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

if [[ -z "$container_ip" ]]; then
    error 1 "Unable to determine container IP address for ${container}"
fi

declare -r webhook_url="https://${container_ip}:9000/hooks/"
declare -r auth_token="$(bin/New-WebhookExecutorToken --silent)"

note "Starting webhook deployment tests for destination: $destination"
declare -r start_time=$(date +%s)
passed_tests=0
failed_tests=0

while IFS= read -r line; do
    if [[ -n ${line:-} ]]; then
        if test_command "$line"; then
            ((passed_tests++)) || :
        else
            ((failed_tests++)) || :
        fi
    fi
done < <(printf '%s' "$commands" | awk 'BEGIN { RS = "[[:space:]]*;[[:space:]]*" } { print $0 }')

declare -r elapsed=$(($(date +%s) - start_time))

note "Test Run Complete:
Status: [$passed_tests Passed, $failed_tests Failed]
Duration: ${elapsed}s"
