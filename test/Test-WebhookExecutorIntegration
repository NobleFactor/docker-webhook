#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebhookExecutorIntegration - Test webhook hook responses inside the container via webhook service
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/../bin/Declare-BashScript" "$0" "help,command:,location:,trigger:" "h" "$@"

###########
# Variables
###########

declare -r curl_timeout=10

###########
# Functions
###########

function test_command {

    local command="$1"
    local correlationId="$(uuidgen)"

    note "==> Testing command: ${trigger} ${command}"

    local response=$(curl --silent --insecure --max-time "$curl_timeout" \
        --get "${webhook_url}${trigger}" \
        --data-urlencode "destination=${destination}" \
        --data-urlencode "command=${command}" \
        --data-urlencode "correlationId=${correlationId}" \
        --header "Authorization: Bearer ${auth_token}")

    if [[ -z "$response" ]]; then
        error 0 "FAIL: No response from ${webhook_url} for ${trigger} ${command}."
        return 1
    fi

    if ! echo "$response" | jq -e '.status and .reason and (.error == null or type == "string") and has("stdout") and has("stderr") and has("authToken") and has("correlationId")' >/dev/null 2>&1; then
        error 0 "FAIL: Invalid response from ${webhook_url} for ${trigger} $command: $response"
        return 1
    fi

    success "PASS: ${trigger} ${command} returned valid JSON: $response"
    return 0
}

###########
# Arguments
###########

declare -r synopsis="${script_name} --help | --location LOCATION --trigger TRIGGER --command CMD [--command CMD ...]"
eval set -- "$script_arguments"

while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --command)
        commands="$2"
        shift 2
        ;;
    --location)
        location="$2"
        shift 2
        ;;
    --trigger)
        trigger="$2"
        shift 2
        ;;
    --)
        shift
        break
        ;;
    *)
        error 2 "Unrecognized option: $1"
        ;;
    esac
done

# --command

[[ -n ${commands:-} ]] || error 2 "A semicolon-separated list of test commands is required."
declare -r commands

# --location

[[ -n ${location:-} ]] || error 2 "A value for location is required."
declare -r location

# --trigger

[[ -n ${trigger:-} ]] || error 2 "A value for trigger is required."
declare -r trigger

###########
# Main
###########

# Check that we're ready to run with a container that we can talk to

IFS=' ' read -r webhook_image webhook_container webhook_ports <<<"$(docker ps --format '{{.Image}} {{.Names}} {{.Ports}}' | grep -E "^noblefactor/webhook:")"

[[ -n ${webhook_container:-} ]] || error 1 "No running noblefactor/webhook container found."
[[ -n ${webhook_ports:-} ]] || error 1 "No port mappings found for the webhook container: ${webhook_container}"

webhook_port="$(echo "${webhook_ports}" | awk 'BEGIN { RS = "[[:space:]]*,[[:space:]]*"; FS="[[:space:]]*->[[:space:]]*"} { split($2, port, "/"); print port[1]}' | sort -u)"
[[ -n ${webhook_port:-} ]] || error 1 "Failed to extract a port from the container mappings for ${webhook_container}: ${webhook_ports}"

webhook_url="https://localhost:${webhook_port}/hooks/"

# Get a fresh authorization token

declare -r webhook_env="$(realpath -q "${script_root}/../volumes/${location}/hooks.env")"

if [[ ! -f "${webhook_env}" ]]; then
    error 1 "Webhook environment file not found: ${webhook_env}"
fi

declare -r auth_token="$("${script_root}/../bin/New-WebhookExecutorToken" --silent --env-file "${webhook_env}")"

# Start the test container

declare -r destination="$("${script_root}/Start-WebhookExecutorTestContainer" --location "${location}")"

note "Starting webhook deployment tests for destination: $destination"
declare -r start_time=$(date +%s)
passed_tests=0
failed_tests=0

while IFS= read -r line; do
    if [[ -n ${line:-} ]]; then
        if test_command "$line"; then
            ((passed_tests++)) || :
        else
            ((failed_tests++)) || :
        fi
    fi
done < <(printf '%s' "$commands" | awk 'BEGIN { RS = "[[:space:]]*;[[:space:]]*" } { print $0 }')

declare -r elapsed=$(($(date +%s) - start_time))

note "==> Test Complete: Test-WebhookExecutorIntegration - Status: [$passed_tests Passed, $failed_tests Failed] Duration: ${elapsed}s"

if ((failed_tests > 0)); then
    exit 1
fi
