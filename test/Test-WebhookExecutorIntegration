#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

# Test-WebhookExecutorIntegration - Test webhook hook responses inside the container via webhook service
# shellcheck source=../bin/Declare-BashScript

source "$(dirname "$0")/../bin/Declare-BashScript" "$0" "help,command:,destination:,keyvault-url:,secret-name:,service-principal-name:,service-principal-password:,webhook-url:" "h" "$@"

###########
# Variables
###########

declare -r curl_timeout=10

###########
# Functions
###########

function test_command {
    local cmd="$1"

    echo "==> Testing command: $cmd"

    local response=$(curl --silent --insecure --max-time "$curl_timeout" -H "Authorization: Bearer ${jwt}" \
        "${webhook_url}?hostname=${destination}&command=${cmd}")

    if [[ -z "$response" ]]; then
        error 0 "FAIL: No response from $cmd"
        return 1
    fi

    if ! echo "$response" | jq -e '.exit_code and .reason and (.error == null or type == "string") and has("stdout") and has("stderr")' >/dev/null 2>&1; then
        error 0 "FAIL: Invalid JSON response for $cmd: $response"
        return 1
    fi

    success "PASS: $cmd returned valid JSON: $response"
    return 0
}

###########
# Arguments
###########

declare -r synopsis="${script_name} --help | --webhook-url URL --destination DESTINATION --keyvault-url URL --secret-name NAME --service-principal-name NAME --service-principal-password PASSWORD --command CMD [--command CMD ...]"
eval set -- "$script_arguments"
declare -a commands=()

while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
        usage "$synopsis"
        ;;
    --command)
        commands+=("$2")
        shift 2
        ;;
    --destination)
        declare -r destination="$2"
        shift 2
        ;;
    --keyvault-url)
        declare -r keyvault_url="$2"
        shift 2
        ;;
    --secret-name)
        declare -r secret_name="$2"
        shift 2
        ;;
    --service-principal-name)
        declare -r service_principal_name="$2"
        shift 2
        ;;
    --service-principal-password)
        declare -r service_principal_password="$2"
        shift 2
        ;;
    --webhook-url)
        declare -r webhook_url="$2"
        shift 2
        ;;
    --)
        shift
        break
        ;;
    *)
        error 1 "Unrecognized option: $1"
        ;;
    esac
done

((${#commands[@]} > 0)) || error 1 "At least one command to test is required."
[[ -n ${destination:-} ]] || error 1 "A non-blank value for destination is required."
[[ -n ${webhook_url:-} ]] || error 1 "A non-blank value for webhook-url is required."
[[ -n ${service_principal_name:-} ]] || error 1 "A non-blank value for service-principal-name is required."
[[ -n ${service_principal_password:-} ]] || error 1 "A non-blank value for service-principal-password is required."
[[ -n ${keyvault_url:-} ]] || error 1 "A non-blank value for keyvault-url is required."
[[ -n ${secret_name:-} ]] || error 1 "A non-blank value for secret-name is required."

# Fetch AZURE_CLIENT_ID and AZURE_TENANT_ID from service principal display name

sp_info=$(az ad sp list --display-name "$service_principal_name" --query "[].{appId:appId, appOwnerTenantId:appOwnerTenantId}" -o json | jq -r '.[0]')

if [[ -z "$sp_info" || "$sp_info" == "null" ]]; then
    error 1 "Service principal '$service_principal_name' not found."
fi

export AZURE_CLIENT_ID=$(echo "$sp_info" | jq -r '.appId') AZURE_TENANT_ID=$(echo "$sp_info" | jq -r '.appOwnerTenantId')

# Fetch JWT from Key Vault

declare -r jwt=$(./bin/Get-JsonWebToken --keyvault-url "$keyvault_url" --secret-name "$secret_name") || {
    error 1 "Failed to fetch JSON Web Token from $keyvault_url"
}

###########
# Main
###########

if docker ps -a --filter name=webhook-executor-destination --format "{{.Names}}" | grep -q webhook-executor-destination; then
    if ! docker ps --filter name=webhook-executor-destination --format "{{.Names}}" | grep -q webhook-executor-destination; then
        sudo docker start webhook-executor-destination
    fi
else
    sudo docker build -t webhook-executor-image -f Dockerfile.webhook-executor-destination .
    sudo docker run -d --name webhook-executor-destination webhook-executor-image
fi

declare -r start_time=$(date +%s)

note "Starting webhook deployment tests for destination: $destination"
passed_tests=0
failed_tests=0

for cmd in "${commands[@]}"; do
    if test_command "$cmd"; then
        ((passed_tests++))
    else
        ((failed_tests++))
    fi
done

declare -r end_time=$(date +%s)
declare -r elapsed=$((end_time - start_time))

note "Test Run Complete:
Status: [$passed_tests Passed, $failed_tests Failed]
Duration: ${elapsed}s"
