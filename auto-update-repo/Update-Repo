#!/usr/bin/env bash

########################################################################################################################
# SPDX-FileCopyrightText: 2016-2025 Noble Factor
# SPDX-License-Identifier: MIT
########################################################################################################################

set -o pipefail

# Set path to this script
scriptpath="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
# Get script's name
scriptname="${BASH_SOURCE[0]##*/}"

check_and_update() {
  # Get inside the git repo directory
  cd "${scriptpath}"/.. || exit 1
  # Get the branch currently used
  curbranch=$(git rev-parse --abbrev-ref HEAD)
  # Get latest updates to the repo
  git fetch --all && \
  git reset --hard origin/"${curbranch}"

  # Get latest release of webhook and release used in this repo
  latest_release=$(curl -sf https://api.github.com/repos/adnanh/webhook/releases/latest | \
    jq -r '.tag_name // empty' 2>/dev/null || \
    curl -s https://api.github.com/repos/adnanh/webhook/releases/latest | \
    grep -o '"tag_name": *"[^"]*"' | cut -d'"' -f4)
  local_release=$(grep "^ENV.*WEBHOOK_VERSION" "${scriptpath}"/../Dockerfile | awk -F '=' '{ print $2 }')

  # Compare releases and update Dockerfile in case they differ
  if [[ "${local_release}" != "${latest_release}" ]] && [[ -n ${latest_release} ]]; then
    # Update the Dockerfile with new version
    sed -i "s/WEBHOOK_VERSION=${local_release}/WEBHOOK_VERSION=${latest_release}/g" "${scriptpath}"/../Dockerfile

    # Commit and push changes
    git add "${scriptpath}"/../Dockerfile
    git commit -m "- bump webhook version to ${latest_release}"

    # Push and create release if credentials are provided
    if [[ -n ${GITHUB_USER} ]] && [[ -n ${GITHUB_TOKEN} ]]; then
      git push origin "${curbranch}" && \
      curl -sf -X POST -H "Content-Type: application/json" \
        -H "Authorization: token ${GITHUB_TOKEN}" \
        -d '{"tag_name":"'"${latest_release}"'","target_commitish":"'"${curbranch}"'","name":"webhook '"${latest_release}"'","body":"Release for webhook version '"${latest_release}"'.","draft":false,"prerelease":false}' \
        https://api.github.com/repos/"${GITHUB_USER}"/docker-webhook/releases
    else
      git push origin "${curbranch}"
      echo "GitHub credentials not provided - skipping release creation"
    fi

    echo "Updated webhook version from ${local_release} to ${latest_release}"
  else
    echo "Webhook version is up to date (${local_release})"
  fi
}

argmissing() {
  echo "Usage: $0 [--user GITHUB_USERNAME] [--token GITHUB_TOKEN] [--write-crontab]"
  echo
  echo "Switches:"
  echo -e "\t--user\t\t\tSpecify GitHub username - optional (required for release creation)."
  echo -e "\t--token\t\t\tSpecify GitHub personal access token - optional (required for release creation)."
  echo -e "\t--write-crontab\t\tAdd crontab entry for this script - optional."
  echo
  echo "Examples:"
  echo -e "\t$0"
  echo -e "\t$0 --user someuser --token ghp_sometoken"
  echo -e "\t$0 --user someuser --token ghp_sometoken --write-crontab"
  echo -e "\t$0 --write-crontab"
  echo
  echo "Note: GitHub credentials are only needed for automatic release creation."
  echo "      The script will still update the Dockerfile without them."
  exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --user)
      github_user="$2"
      shift 2
      ;;
    --token)
      github_token="$2"
      shift 2
      ;;
    --write-crontab)
      write_crontab=true
      shift
      ;;
    --help|-h)
      argmissing
      ;;
    *)
      echo "Unknown option: $1"
      argmissing
      ;;
  esac
done

# Handle crontab creation
if [[ "${write_crontab:-}" == "true" ]]; then
  if ! crontab -l 2>/dev/null | grep -q "${scriptname}"; then
    echo "Creating crontab entry."
    cron_cmd="${scriptpath}/${scriptname}"
    if [[ -n ${github_user:-} ]] && [[ -n ${github_token:-} ]]; then
      cron_cmd="${cron_cmd} --user ${github_user} --token ${github_token}"
    fi
    (crontab -l 2>/dev/null; echo -e "# Check for webhook releases every five minutes
*/5 * * * * ${cron_cmd} > /dev/null 2>&1") | crontab -
    echo "Crontab entry created successfully."
  else
    echo "Crontab entry already exists."
  fi
fi

# Run the main function
check_and_update

exit 0
